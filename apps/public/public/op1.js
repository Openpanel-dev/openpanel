"use strict";(()=>{var c=class{constructor(e){this.baseUrl=e.baseUrl,this.headers={"Content-Type":"application/json",...e.defaultHeaders},this.maxRetries=e.maxRetries??3,this.initialRetryDelay=e.initialRetryDelay??500}async resolveHeaders(){let e={};for(let[t,n]of Object.entries(this.headers)){let r=await n;r!==null&&(e[t]=r)}return e}addHeader(e,t){this.headers[e]=t}async post(e,t,n,r){try{let i=await fetch(e,{method:"POST",headers:await this.resolveHeaders(),body:JSON.stringify(t??{}),keepalive:!0,...n});if(i.status===401)return null;if(i.status!==200&&i.status!==202)throw new Error(`HTTP error! status: ${i.status}`);let s=await i.text();return s?JSON.parse(s):null}catch(i){if(r<this.maxRetries){let s=this.initialRetryDelay*2**r;return await new Promise(a=>setTimeout(a,s)),this.post(e,t,n,r+1)}return console.error("Max retries reached:",i),null}}async fetch(e,t,n={}){let r=`${this.baseUrl}${e}`;return this.post(r,t,n,0)}};var l=class{constructor(e){this.options=e;this.queue=[];let t={"openpanel-client-id":e.clientId};e.clientSecret&&(t["openpanel-client-secret"]=e.clientSecret),t["openpanel-sdk-name"]=e.sdk||"node",t["openpanel-sdk-version"]=e.sdkVersion||process.env.SDK_VERSION,this.api=new c({baseUrl:e.apiUrl||"https://api.openpanel.dev",defaultHeaders:t})}init(){}ready(){this.options.waitForProfile=!1,this.flush()}async send(e){return this.options.disabled||this.options.filter&&!this.options.filter(e)?Promise.resolve():this.options.waitForProfile&&!this.profileId?(this.queue.push(e),Promise.resolve()):this.api.fetch("/track",e)}setGlobalProperties(e){this.global={...this.global,...e}}async track(e,t){return this.send({type:"track",payload:{name:e,profileId:t?.profileId??this.profileId,properties:{...this.global??{},...t??{}}}})}async identify(e){if(e.profileId&&(this.profileId=e.profileId,this.flush()),Object.keys(e).length>1)return this.send({type:"identify",payload:{...e,properties:{...this.global,...e.properties}}})}async alias(e){return this.send({type:"alias",payload:e})}async increment(e){return this.send({type:"increment",payload:e})}async decrement(e){return this.send({type:"decrement",payload:e})}async revenue(e,t){let n=t?.deviceId;return delete t?.deviceId,this.track("revenue",{...t??{},...n?{__deviceId:n}:{},__revenue:e})}async fetchDeviceId(){return(await this.api.fetch("/track/device-id",void 0,{method:"GET",keepalive:!1}))?.deviceId??""}clear(){this.profileId=void 0}flush(){this.queue.forEach(e=>{this.send({...e,payload:{...e.payload,profileId:e.payload.profileId??this.profileId}})}),this.queue=[]}};function h(o){return o.replace(/([-_][a-z])/gi,e=>e.toUpperCase().replace("-","").replace("_",""))}var d=class extends l{constructor(t){super({sdk:"web",sdkVersion:"1.0.4",...t});this.options=t;this.lastPath="";this.pendingRevenues=[];if(!this.isServer()){console.log("OpenPanel.dev - Initialized",this.options);try{let n=sessionStorage.getItem("openpanel-pending-revenues");if(n){let r=JSON.parse(n);Array.isArray(r)&&(this.pendingRevenues=r)}}catch{this.pendingRevenues=[]}this.setGlobalProperties({__referrer:document.referrer}),this.options.trackScreenViews&&(this.trackScreenViews(),setTimeout(()=>this.screenView(),0)),this.options.trackOutgoingLinks&&this.trackOutgoingLinks(),this.options.trackAttributes&&this.trackAttributes()}}debounce(t,n){clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(t,n)}isServer(){return typeof document>"u"}trackOutgoingLinks(){this.isServer()||document.addEventListener("click",t=>{let n=t.target,r=n.closest("a");if(r&&n){let i=r.getAttribute("href");if(i?.startsWith("http"))try{let s=new URL(i),a=window.location.hostname;s.hostname!==a&&super.track("link_out",{href:i,text:r.innerText||r.getAttribute("title")||n.getAttribute("alt")||n.getAttribute("title")})}catch{}}})}trackScreenViews(){if(this.isServer())return;let t=history.pushState;history.pushState=function(...s){let a=t.apply(this,s);return window.dispatchEvent(new Event("pushstate")),window.dispatchEvent(new Event("locationchange")),a};let n=history.replaceState;history.replaceState=function(...s){let a=n.apply(this,s);return window.dispatchEvent(new Event("replacestate")),window.dispatchEvent(new Event("locationchange")),a},window.addEventListener("popstate",()=>{window.dispatchEvent(new Event("locationchange"))});let r=()=>this.debounce(()=>this.screenView(),50);this.options.trackHashChanges?window.addEventListener("hashchange",r):window.addEventListener("locationchange",r)}trackAttributes(){this.isServer()||document.addEventListener("click",t=>{let n=t.target,r=n.closest("button"),i=n.closest("a"),s=r?.getAttribute("data-track")?r:i?.getAttribute("data-track")?i:null;if(s){let a={};for(let p of s.attributes)p.name.startsWith("data-")&&p.name!=="data-track"&&(a[h(p.name.replace(/^data-/,""))]=p.value);let u=s.getAttribute("data-track");u&&super.track(u,a)}})}screenView(t,n){if(this.isServer())return;let r,i;typeof t=="string"?(r=t,i=n):(r=window.location.href,i=t),this.lastPath!==r&&(this.lastPath=r,console.log("OpenPanel.dev - Track page view"),super.track("screen_view",{...i??{},__path:r,__title:document.title}))}async flushRevenue(){let t=this.pendingRevenues.map(n=>super.revenue(n.amount,n.properties));await Promise.all(t),this.clearRevenue()}clearRevenue(){if(this.pendingRevenues=[],!this.isServer())try{sessionStorage.removeItem("openpanel-pending-revenues")}catch{}}pendingRevenue(t,n){if(this.pendingRevenues.push({amount:t,properties:n}),!this.isServer())try{sessionStorage.setItem("openpanel-pending-revenues",JSON.stringify(this.pendingRevenues))}catch{}}};(o=>{if(o.op){let e=o.op.q||[],t=new d(e.shift()[1]);e.forEach(r=>{r[0]in t&&t[r[0]](...r.slice(1))});let n=new Proxy((r,...i)=>{let s=t[r]?t[r].bind(t):void 0;typeof s=="function"?s(...i):console.warn(`OpenPanel: ${r} is not a function`)},{get(r,i){if(i==="q")return;let s=t[i];return typeof s=="function"?s.bind(t):s}});o.op=n,o.openpanel=t}})(window);})();
